# Automatic master deployment workflow
# Trigger: Push to master (typically after PR merge)
# Use case: Deploy to staging automatically, optionally promote to production

name: Deploy Master

on:
  push:
    branches:
      - master
      - main
    paths:
      # Only deploy when relevant code changes
      - 'packages/**'
      - 'docker/**'
      - 'pyproject.toml'
      - '.github/workflows/deploy-*.yml'

env:
  REGISTRY: us-central1-docker.pkg.dev
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: us-central1

jobs:
  # Detect which packages changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      core: ${{ steps.filter.outputs.core }}
      api: ${{ steps.filter.outputs.api }}
      ui: ${{ steps.filter.outputs.ui }}
      any_service: ${{ steps.filter.outputs.api == 'true' || steps.filter.outputs.ui == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            core:
              - 'packages/core/**'
              - 'pyproject.toml'
            api:
              - 'packages/api/**'
              - 'packages/core/**'
              - 'docker/Dockerfile.api'
            ui:
              - 'packages/ui/**'
              - 'packages/core/**'
              - 'docker/Dockerfile.ui'

  # Run full test suite
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install -e packages/core

      - name: Run linting
        run: |
          ruff check packages/core/src packages/core/tests

      - name: Run unit tests
        run: |
          python -m pytest packages/core/tests -v \
            --ignore=packages/core/tests/knowledge_graph \
            -x --tb=short

  # Build changed services
  build:
    needs: [changes, test]
    if: needs.changes.outputs.any_service == 'true'
    uses: ./.github/workflows/build-images.yml
    with:
      services: |
        ${{ needs.changes.outputs.api == 'true' && 'api' || '' }}${{ needs.changes.outputs.api == 'true' && needs.changes.outputs.ui == 'true' && ',' || '' }}${{ needs.changes.outputs.ui == 'true' && 'ui' || '' }}
      image_tag: latest
      push: true
    secrets: inherit

  # Deploy to staging
  deploy-staging:
    needs: [changes, build]
    if: needs.changes.outputs.any_service == 'true'
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy API to staging
        if: needs.changes.outputs.api == 'true'
        run: |
          gcloud run deploy agentic-kg-api-staging \
            --image=${{ needs.build.outputs.api_image }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --port=8000 \
            --memory=1Gi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --set-secrets=NEO4J_URI=NEO4J_URI:latest,NEO4J_PASSWORD=NEO4J_PASSWORD:latest,OPENAI_API_KEY=OPENAI_API_KEY:latest \
            --allow-unauthenticated \
            --labels=environment=staging,commit=${{ github.sha }}

      - name: Deploy UI to staging
        if: needs.changes.outputs.ui == 'true'
        run: |
          gcloud run deploy agentic-kg-ui-staging \
            --image=${{ needs.build.outputs.ui_image }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --port=8501 \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5 \
            --set-secrets=OPENAI_API_KEY=OPENAI_API_KEY:latest \
            --allow-unauthenticated \
            --labels=environment=staging,commit=${{ github.sha }}

      - name: Get staging URLs
        id: urls
        run: |
          if [ "${{ needs.changes.outputs.api }}" = "true" ]; then
            API_URL=$(gcloud run services describe agentic-kg-api-staging \
              --region=${{ env.REGION }} --format='value(status.url)')
            echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          fi

          if [ "${{ needs.changes.outputs.ui }}" = "true" ]; then
            UI_URL=$(gcloud run services describe agentic-kg-ui-staging \
              --region=${{ env.REGION }} --format='value(status.url)')
            echo "ui_url=${UI_URL}" >> $GITHUB_OUTPUT
          fi

      - name: Create staging deployment summary
        run: |
          echo "## Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.changes.outputs.api }}" = "true" ]; then
            echo "- **API:** ${{ steps.urls.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.changes.outputs.ui }}" = "true" ]; then
            echo "- **UI:** ${{ steps.urls.outputs.ui_url }}" >> $GITHUB_STEP_SUMMARY
          fi

  # Run integration tests against staging
  integration-test:
    needs: [deploy-staging]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install test dependencies
        run: |
          pip install pytest requests

      - name: Run integration tests
        run: |
          # Placeholder for integration tests against staging
          echo "Integration tests would run here"
          # pytest tests/integration --base-url=$STAGING_API_URL

  # Update deployment manifest
  update-manifest:
    needs: [deploy-staging, integration-test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: master

      - name: Update deployment manifest
        run: |
          mkdir -p deploy
          cat > deploy/deployment-manifest.yaml << EOF
          # Auto-generated deployment manifest
          # Last updated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

          environment: staging
          deployed_at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          deployed_by: github-actions
          commit: ${{ github.sha }}

          services:
            api:
              image: ${{ needs.build.outputs.api_image || 'not-deployed' }}
              sha: ${{ github.sha }}
            ui:
              image: ${{ needs.build.outputs.ui_image || 'not-deployed' }}
              sha: ${{ github.sha }}
          EOF

      - name: Commit manifest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add deploy/deployment-manifest.yaml
          git diff --staged --quiet || git commit -m "chore: update deployment manifest [skip ci]"
          git push || echo "Nothing to push"
