# Google Cloud Build configuration
# This file is used for manual Cloud Build triggers or local gcloud builds
#
# Usage:
#   # Build and deploy API service
#   gcloud builds submit --config=cloudbuild.yaml \
#     --substitutions=_SERVICE=api,COMMIT_SHA=$(git rev-parse HEAD)
#
#   # Build specific service with version
#   gcloud builds submit --config=cloudbuild.yaml \
#     --substitutions=_SERVICE=ui,_VERSION=v1.0.0,COMMIT_SHA=$(git rev-parse HEAD)

substitutions:
  _SERVICE: api  # api, ui, or worker
  _VERSION: ''   # Optional version tag (e.g., v1.0.0)
  _REGION: us-central1
  _REPOSITORY: agentic-kg

steps:
  # Get API URL for UI build (needed at build time for Next.js)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'get-api-url'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "${_SERVICE}" = "ui" ]; then
          echo "Fetching API URL for UI build..."
          API_URL=$(gcloud run services describe agentic-kg-api-staging --region=${_REGION} --format='value(status.url)' 2>/dev/null || echo "")
          echo "API URL found: $${API_URL}"
          echo "$${API_URL}" > /workspace/api_url.txt
          echo "Saved to /workspace/api_url.txt"
        else
          echo "" > /workspace/api_url.txt
        fi

  # Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        API_URL=$(cat /workspace/api_url.txt)
        echo "Read API URL from file: '$${API_URL}'"
        BUILD_ARGS=""
        if [ "${_SERVICE}" = "ui" ] && [ -n "$${API_URL}" ]; then
          BUILD_ARGS="--build-arg NEXT_PUBLIC_API_URL=$${API_URL}"
          echo "Build args for UI: $${BUILD_ARGS}"
        fi
        echo "Running docker build with args: $${BUILD_ARGS}"
        docker build \
          -f docker/Dockerfile.${_SERVICE} \
          -t ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE}:$COMMIT_SHA \
          -t ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE}:latest \
          $${BUILD_ARGS} \
          .

  # Tag with version if provided
  - name: 'gcr.io/cloud-builders/docker'
    id: 'tag-version'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ -n "${_VERSION}" ]; then
          docker tag \
            ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE}:$COMMIT_SHA \
            ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE}:${_VERSION}
        fi

  # Push SHA-tagged image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-sha'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE}:$COMMIT_SHA'

  # Push latest-tagged image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-latest'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE}:latest'

  # Push version-tagged image if provided
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-version'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ -n "${_VERSION}" ]; then
          docker push \
            ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE}:${_VERSION}
        fi

  # Deploy to Cloud Run (staging by default)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Determine port based on service
        case "${_SERVICE}" in
          api) PORT=8000 ;;
          ui) PORT=3000 ;;
          worker) PORT=8080 ;;
        esac

        # Determine memory based on service
        case "${_SERVICE}" in
          api) MEMORY=1Gi ;;
          ui) MEMORY=512Mi ;;
          worker) MEMORY=2Gi ;;
        esac

        # Set secrets based on service
        case "${_SERVICE}" in
          api) SECRETS="NEO4J_URI=NEO4J_URI:latest,NEO4J_PASSWORD=NEO4J_PASSWORD:latest,OPENAI_API_KEY=OPENAI_API_KEY:latest,ANTHROPIC_API_KEY=ANTHROPIC_API_KEY:latest" ;;
          ui) SECRETS="" ;;  # UI only needs API_URL, set below
          worker) SECRETS="NEO4J_URI=NEO4J_URI:latest,NEO4J_PASSWORD=NEO4J_PASSWORD:latest,OPENAI_API_KEY=OPENAI_API_KEY:latest" ;;
        esac

        # Set env vars based on service
        case "${_SERVICE}" in
          api)
            # Get UI URLs for CORS
            UI_URL_NEW=$(gcloud run services describe agentic-kg-ui-staging --region=${_REGION} --format='value(status.url)' 2>/dev/null || echo "")
            UI_URL_LEGACY=$(gcloud run services describe agentic-kg-ui-staging --region=${_REGION} --format='value(status.traffic[0].url)' 2>/dev/null || echo "")
            ENV_VARS="CORS_ORIGINS=http://localhost:3000;http://localhost:8501;$${UI_URL_NEW};$${UI_URL_LEGACY}"
            ;;
          ui)
            API_URL=$(gcloud run services describe agentic-kg-api-staging --region=${_REGION} --format='value(status.url)' 2>/dev/null || echo "")
            ENV_VARS="API_URL=$${API_URL},NODE_ENV=production"
            ;;
          *) ENV_VARS="" ;;
        esac

        # Build deploy command
        DEPLOY_CMD="gcloud run deploy agentic-kg-${_SERVICE}-staging \
          --image=${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE}:$COMMIT_SHA \
          --region=${_REGION} \
          --platform=managed \
          --port=$$PORT \
          --memory=$$MEMORY \
          --min-instances=0 \
          --max-instances=10 \
          --allow-unauthenticated"

        # Add secrets if any
        if [ -n "$$SECRETS" ]; then
          DEPLOY_CMD="$$DEPLOY_CMD --set-secrets=$$SECRETS"
        fi

        # Add env vars if any
        if [ -n "$$ENV_VARS" ]; then
          DEPLOY_CMD="$$DEPLOY_CMD --set-env-vars=$$ENV_VARS"
        fi

        # Deploy to staging
        eval $$DEPLOY_CMD

images:
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE}:$COMMIT_SHA'
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE}:latest'

timeout: 1800s

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'
