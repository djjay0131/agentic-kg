# Docker Compose for Agentic Knowledge Graph local development
#
# Usage:
#   # Start all services
#   docker compose -f docker/docker-compose.yml up -d
#
#   # Start only Neo4j (for development with local Python)
#   docker compose -f docker/docker-compose.yml up neo4j -d
#
#   # Start specific services
#   docker compose -f docker/docker-compose.yml up neo4j api -d
#
#   # View logs
#   docker compose -f docker/docker-compose.yml logs -f api
#
#   # Stop all services
#   docker compose -f docker/docker-compose.yml down
#
# IMPORTANT: Copy .env.example to .env and configure before running
#   cp docker/.env.example docker/.env

version: "3.8"

services:
  # ==========================================================================
  # Neo4j Database - Core dependency for all services
  # ==========================================================================
  neo4j:
    image: neo4j:5.15.0-community
    container_name: agentic-kg-neo4j
    ports:
      - "7474:7474"  # HTTP (Browser UI)
      - "7687:7687"  # Bolt (Driver connections)
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:?NEO4J_PASSWORD must be set}
      - NEO4J_PLUGINS=["apoc"]
      # Enable vector index support
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
      # Memory settings (adjust based on available RAM)
      - NEO4J_server_memory_heap_initial__size=512m
      - NEO4J_server_memory_heap_max__size=1G
      - NEO4J_server_memory_pagecache_size=512m
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_plugins:/plugins
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7474"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - agentic-kg-network

  # ==========================================================================
  # API Service - FastAPI backend (when implemented)
  # ==========================================================================
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: agentic-kg-api
    ports:
      - "8000:8000"
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:?NEO4J_PASSWORD must be set}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      neo4j:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - agentic-kg-network
    # Uncomment when API service is implemented
    profiles:
      - full
      - api

  # ==========================================================================
  # UI Service - Next.js frontend
  # ==========================================================================
  ui:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ui
    container_name: agentic-kg-ui
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - API_URL=http://api:8000
    depends_on:
      - api
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    networks:
      - agentic-kg-network
    profiles:
      - full
      - ui

  # ==========================================================================
  # Worker Service - Background task processor (when implemented)
  # ==========================================================================
  worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile.worker
    container_name: agentic-kg-worker
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:?NEO4J_PASSWORD must be set}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
    depends_on:
      neo4j:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - agentic-kg-network
    # Uncomment when worker service is implemented
    profiles:
      - full
      - worker

  # ==========================================================================
  # Redis - Task queue backend for workers (optional)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: agentic-kg-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - agentic-kg-network
    profiles:
      - full
      - worker

# ==========================================================================
# Networks
# ==========================================================================
networks:
  agentic-kg-network:
    driver: bridge

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_plugins:
    driver: local
  redis_data:
    driver: local
